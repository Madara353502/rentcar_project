{% extends 'main/base.html' %}
{% load static %}
{% load tz %}

{% block title %}Profile{% endblock title %}

{% block content %}
    <div class="container mt-4">
        <h2 class="mb-3">Your Profile</h2>
        <div class="row">
            <div class="col-md-4">
                <div class="bg-white p-3 mb-3 rounded shadow-sm">
                    <h5 class="mb-2">Account Details</h5>
                    <div class="profile-avatar mb-3">
                        {% if user.image %}
                            <img src="{{ user.image.url }}" alt="Avatar">
                        {% else %}
                            <img src="{% static 'img/noimage.jpg' %}" alt="Avatar">
                        {% endif %}
                    </div>
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="mb-2">
                            <label for="id_image" class="form-label small text-muted">Change Avatar</label>
                            <input type="file" class="form-control form-control-sm" id="id_image"
                                   name="image" accept="image/*">
                        </div>
                        <div class="mb-2">
                            <label for="id_first_name" class="form-label small text-muted">First Name</label>
                            <input type="text" class="form-control form-control-sm" id="id_first_name"
                                   name="first_name" value="{{ form.first_name.value|default:user.first_name }}"
                                   required>
                        </div>
                        <div class="mb-2">
                            <label for="id_last_name" class="form-label small text-muted">Last Name</label>
                            <input type="text" class="form-control form-control-sm" id="id_last_name"
                                   name="last_name" value="{{ form.last_name.value|default:user.last_name }}"
                                   required>
                        </div>
                        <div class="mb-2">
                            <label for="id_username" class="form-label small text-muted">Username</label>
                            <input type="text" class="form-control form-control-sm" id="id_username"
                                   name="username" value="{{ form.username.value|default:user.username }}"
                                   required>
                        </div>
                        <div class="mb-2">
                            <label for="id_email" class="form-label small text-muted">Email</label>
                            <input type="email" class="form-control form-control-sm" id="id_email"
                                   name="email" value="{{ form.email.value|default:user.email }}"
                                   required>
                        </div>
                        <button type="submit" class="btn btn-primary btn-sm w-100" name="profile_submit">Save Details</button>
                    </form>
                    <hr class="my-3">
                    <h6 class="mb-2">Timezone</h6>
                    <form method="post">
                        {% csrf_token %}
                        {{ timezone_form.as_p }}
                        <button type="submit" class="btn btn-primary btn-sm w-100" name="timezone_submit">Update Timezone</button>
                    </form>
                    <hr class="my-3">
                    <a class="btn btn-secondary btn-sm w-100" href="{% url "user:logout" %}">Logout</a>
                </div>
            </div>
            <div class="col-md-8">
                <div class="bg-white p-3 mb-3 rounded shadow-sm">
                    <h5 class="mb-3">Your Orders</h5>
                    {% if orders %}
                        <div class="list-group">
                            {% for order in orders %}
                                <div class="list-group-item mb-2 rounded">
                                    <h6 class="mb-1">Order â„– {{ order.id }} <small class="text-muted float-end">Ordered on: {{ order.created|timezone:user.timezone_info.timezone }}</small></h6>
                                    {% for item in order.items.all %}
                                        <p class="mb-0 small order-item-details">
                                            <span class="product-label">Product:</span> {{ item.product.name }} (Qty: {{ item.quantity }}, Price: ${{ item.price }})
                                        </p>
                                    {% endfor %}
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">You haven't ordered anything yet.</p>
                    {% endif %}
                </div>

                <div class="bg-white p-3 mb-3 rounded shadow-sm">
                    <h5 class="mb-3">Your Notes</h5>
                    <form method="post" class="mb-3">
                        {% csrf_token %}
                        <h6 class="mb-2">Create New Note</h6>
                        {{ note_form.as_p }}
                        <button type="submit" class="btn btn-primary btn-sm" name="note_submit">Create Note</button>
                    </form>
                    {% if notes %}
                        <div class="list-group">
                            {% for note in notes %}
                                <div class="list-group-item mb-2 rounded">
                                    <h6 class="mb-1 fw-bold">{{ note.title }} <small class="text-muted float-end">Updated: {{ note.updated_at|timezone:user.timezone_info.timezone }}</small></h6>
                                    <p class="mb-0 small">{{ note.content }}</p>
                                    <small class="text-muted">Created: {{ note.created_at|timezone:user.timezone_info.timezone }}</small>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">You haven't created any notes yet.</p>
                    {% endif %}
                </div>

                <div class="bg-white p-3 mb-3 rounded shadow-sm">
                    <h5 class="mb-3">Your Groups</h5>
                    <form method="post" class="mb-3">
                        {% csrf_token %}
                        <h6 class="mb-2">Create New Group</h6>
                        {{ group_form.as_p }}
                        <button type="submit" class="btn btn-primary btn-sm" name="group_submit">Create Group</button>
                    </form>
                    {% if groups %}
                        <ul class="list-group">
                            {% for group in groups %}
                                <li class="list-group-item rounded">
                                    <h6 class="mb-1 fw-bold">{{ group.name }}</h6>
                                    {% if group.description %}
                                        <p class="mb-0 small text-muted">{{ group.description }}</p>
                                    {% endif %}
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted">You are not a member of any groups yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <style>
        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            overflow: hidden;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .order-item-details .product-label {
            font-weight: normal !important; 
            font-family: sans-serif !important; 
            font-size: inherit !important; 
        }

        .list-group-item .fw-bold {
            font-weight: bold !important;
            font-family: sans-serif !important;
        }

        .list-group-item h6 {
            font-family: sans-serif !important;
        }
    </style>
{% endblock content %}